"use strict";(self.webpackChunk_eightshift_docs=self.webpackChunk_eightshift_docs||[]).push([[20101],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),u=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(a),d=r,m=p["".concat(l,".").concat(d)]||p[d]||h[d]||o;return a?n.createElement(m,s(s({ref:t},c),{},{components:a})):n.createElement(m,s({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[p]="string"==typeof e?e:r,s[1]=i;for(var u=2;u<o;u++)s[u]=a[u];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},80955:function(e,t,a){a.r(t),a.d(t,{assets:function(){return c},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return p}});var n=a(87462),r=a(63366),o=(a(67294),a(3905)),s=["components"],i={title:"Working with custom queries",description:"Explains the process of registering a new service class, adding a custom query and using it in a block.",slug:"working-with-custom-queries",authors:"obradovic",date:new Date("2023-08-01T00:00:00.000Z"),tags:["eightshift","boilerplate","service","class","query"],hide_table_of_contents:!1},l=void 0,u={permalink:"/blog/working-with-custom-queries",source:"@site/blog/2023-08-03-adding-custom-query.md",title:"Working with custom queries",description:"Explains the process of registering a new service class, adding a custom query and using it in a block.",date:"2023-08-01T00:00:00.000Z",formattedDate:"August 1, 2023",tags:[{label:"eightshift",permalink:"/blog/tags/eightshift"},{label:"boilerplate",permalink:"/blog/tags/boilerplate"},{label:"service",permalink:"/blog/tags/service"},{label:"class",permalink:"/blog/tags/class"},{label:"query",permalink:"/blog/tags/query"}],readingTime:3.995,hasTruncateMarker:!0,authors:[{name:"Igor Obradovi\u0107",title:"WordPress Engineer",url:"https://github.com/iobrado",imageURL:"https://avatars.githubusercontent.com/u/23059501?v=4",key:"obradovic"}],frontMatter:{title:"Working with custom queries",description:"Explains the process of registering a new service class, adding a custom query and using it in a block.",slug:"working-with-custom-queries",authors:"obradovic",date:"2023-08-01T00:00:00.000Z",tags:["eightshift","boilerplate","service","class","query"],hide_table_of_contents:!1},nextItem:{title:"Using multiple same components",permalink:"/blog/multiple-same-components"}},c={authorsImageUrls:[void 0]},p=[{value:"Usage in built-in blocks",id:"usage-in-built-in-blocks",level:2},{value:"What are Service classes?",id:"what-are-service-classes",level:2},{value:"Creating a new service class",id:"creating-a-new-service-class",level:2},{value:"Using the new filter",id:"using-the-new-filter",level:2},{value:"Prepare only the data you need",id:"prepare-only-the-data-you-need",level:2},{value:"Best practices for queries",id:"best-practices-for-queries",level:2}],h={toc:p},d="wrapper";function m(e){var t=e.components,a=(0,r.Z)(e,s);return(0,o.kt)(d,(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Eightshift DevKit offers some blocks with query logic out of the box, but what is the best approach when you need to add a custom query to a block you\u2019ve been working on?"),(0,o.kt)("h2",{id:"usage-in-built-in-blocks"},"Usage in built-in blocks"),(0,o.kt)("p",null,"One of the Eightshift blocks that already uses ",(0,o.kt)("inlineCode",{parentName:"p"},"WP_Query")," is the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("em",{parentName:"strong"},"Featured Content"))," block. In that block, you can see the query logic is inside the block. However, there is a much better way to do it. The reason it was done like this was to simplify this block and to have an already functioning block available with one WP-CLI command."),(0,o.kt)("p",null,"A much better approach would be to separate the query logic from the block. Other than following the MVC architecture more closely, this will also make the query logic more reusable. To do this, we\u2019re gonna create a service class."),(0,o.kt)("h2",{id:"what-are-service-classes"},"What are Service classes?"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},'Put simply, a Service is any PHP object that performs some sort of "global" task. - Symfony docs')),(0,o.kt)("p",null,"If you take a look at the ",(0,o.kt)("inlineCode",{parentName:"p"},"ServiceInterface")," interface, you\u2019ll notice it only contains the ",(0,o.kt)("inlineCode",{parentName:"p"},"register()")," method. This method holds action and filter hooks for that class. Other than hooking into existing actions and filters, this method can be used to register our own filters which can be used in blocks or other classes."),(0,o.kt)("p",null,"Basically, whenever you need to hook into actions or filters, you should use a Service class for that."),(0,o.kt)("h2",{id:"creating-a-new-service-class"},"Creating a new service class"),(0,o.kt)("p",null,"Creating a new service class in your project is as simple as using the following WP-CLI command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"wp boilerplate create service-example --folder=CustomQuery --file_name=CustomQuery\n")),(0,o.kt)("p",null,"Once this new class is generated, you can add a new public method that will contain the query logic. We want our method to accept three optional arguments:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ID of the category"),(0,o.kt)("li",{parentName:"ul"},"number of posts per page"),(0,o.kt)("li",{parentName:"ul"},"number of the current page")),(0,o.kt)("p",null,"Having the category ID optional will allow for one more use case, and that is fetching the latest posts regardless of category. By default, WordPress sorts the posts by publish date, from newest to oldest."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"/**\n * Get posts by category ID.\n *\n * @param int $categoryId Category ID.\n * @param int $postsPerPage Number of posts per page.\n * @param int $currentPage Current page number.\n *\n * @return WP_Query Query object.\n */\npublic function getPostsByCategory($categoryId = null, $postsPerPage = 3, $currentPage = 1): WP_Query\n{\n    $postArgs = [\n        'post_type' => 'post',\n        'cat' => $categoryId,\n        'posts_per_page' => $postsPerPage,\n        'paged' => $currentPage,\n    ];\n\n    return new WP_Query($postArgs);\n}\n")),(0,o.kt)("p",null,"To use this method, we can add it as a filter. The filter name should be added as a constant for easier maintenance. Inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"register()")," method, add the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"\\add_filter(self::GET_POSTS_BY_CATEGORY, [$this, 'getPostsByCategory'], 10, 3);\n")),(0,o.kt)("h2",{id:"using-the-new-filter"},"Using the new filter"),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Even if you register a filter for a method that doesn\u2019t accept any arguments, when calling ",(0,o.kt)("inlineCode",{parentName:"p"},"apply_filters"),", you must pass at least 1 parameter. In those cases, simply add ",(0,o.kt)("inlineCode",{parentName:"p"},"null")," as a parameter.")),(0,o.kt)("p",null,"Here are some examples how you can use the filter:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"// Get 3 latest posts, regardless of category.\n$allLatestPosts = apply_filters(CustomQuery::GET_POSTS_BY_CATEGORY, null);\n\n// Get 10 latest posts from the News category. News category ID is 2.\n$latestNews = apply_filters(CustomQuery::GET_POSTS_BY_CATEGORY, 2, 10);\n\n// Get another page of News category.\n$pagedNews = apply_filters(CustomQuery::GET_POSTS_BY_CATEGORY, 2, 10, $currentPage);\n")),(0,o.kt)("p",null,"The above example shows multiple use cases. The first two examples could be used in a simple block that displays only the selected number of the latest posts. The last example may be used in a REST route for a load more functionality or in a block with classic pagination."),(0,o.kt)("p",null,"Now you can do a regular query loop in your block to display the posts:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"if ($latestNews->have_posts()) {\n    while ($latestNews->have_posts()) {\n        $latestNews->the_post();\n        // render the card here with the Components::render helper.\n    }\n}\nwp_reset_postdata();\n")),(0,o.kt)("admonition",{title:"Important",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Don't forget to add ",(0,o.kt)("inlineCode",{parentName:"p"},"wp_reset_postdata()")," after looping through the custom query!")),(0,o.kt)("h2",{id:"prepare-only-the-data-you-need"},"Prepare only the data you need"),(0,o.kt)("p",null,"If you would like to improve this even further, you can run the ",(0,o.kt)("inlineCode",{parentName:"p"},"have_posts()")," loop inside the class and save only the data you need to render to an array. This makes the logic even more separated from the view and all you have to do in a block is loop through the array and populate the component attributes with the values from the array."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-php"},"$postData = [];\n\nif ($queryData->have_posts()) {\n    while($queryData->have_posts()) {\n        $queryData->the_post();\n\n        $postData[] = [\n            'id' => get_the_ID(),\n            'title' => get_the_title(),\n            'url' => get_permalink(),\n            'image' => get_the_post_thumbnail_url(),\n            'date' => get_the_time('d.m.Y.'),\n            'excerpt' => get_the_excerpt(),\n        ];\n    }\n}\n\nwp_reset_postdata();\n\nreturn $postData;\n")),(0,o.kt)("h2",{id:"best-practices-for-queries"},"Best practices for queries"),(0,o.kt)("p",null,"It\u2019s important to have query optimisation in mind. Some queries may be a lot slower and you have to see if there is any way to follow the ",(0,o.kt)("a",{parentName:"p",href:"https://infinum.com/handbook/wordpress/coding-standards/php-coding-standards/database-queries"},"best practices for database queries"),"."))}m.isMDXComponent=!0}}]);